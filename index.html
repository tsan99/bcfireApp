<!DOCTYPE html>
<html>
<head>
  <title>BC Wildfire Map with Fire Status and Hover Info</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet CSS & JS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- Proj4 for projection conversion -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.8.0/proj4.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 10px; }
    #map { height: 500px; margin-top: 15px; }
    .controls { margin-bottom: 10px; }
    label, input { display: block; margin: 4px 0; }
    .legend {
      background: white;
      padding: 6px 8px;
      font-size: 14px;
      box-shadow: 0 0 15px rgba(0,0,0,0.2);
      border-radius: 5px;
      line-height: 18px;
      color: #555;
      position: absolute;
      bottom: 30px;
      left: 10px;
      z-index: 1000;
    }
    .legend i {
      width: 18px;
      height: 18px;
      float: left;
      margin-right: 8px;
      opacity: 0.7;
    }

    /* Info box styles */
    #infoBox {
      position: absolute;
      top: 10px;
      right: 10px;
      min-width: 180px;
      background: rgba(255,255,255,0.9);
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 0 12px rgba(0,0,0,0.3);
      font-size: 14px;
      color: #222;
      pointer-events: none; /* so it doesn't block map events */
      z-index: 1100;
      display: none;
    }
  </style>
</head>
<body>

<h2>üî• BC Wildfire Map (with Fire Status and Hover Info)</h2>

<div class="controls">
  <button onclick="getLocation()">üìç Use My Location</button><br>

  <label>Or manually enter coordinates:</label>
  Latitude: <input type="number" id="lat" step="any" value="53.9171" placeholder="49.xxx">
  Longitude: <input type="number" id="lon" step="any" value="-122.7497" placeholder="-123.xxx">
  <button onclick="manualCheck()">Check Fires Near Me</button>

  <label>Search Radius: <span id="radiusLabel">500</span> km</label>
  <input type="range" id="radiusSlider" min="100" max="1000" step="100" value="500" oninput="updateRadiusLabel()">

  <label><input type="checkbox" id="autoRefresh"> Auto-refresh every 60s</label>
</div>

<p id="status">Status: Waiting‚Ä¶</p>
<div id="map"></div>

<div class="legend" id="legend">
  <strong>Fire Status Legend</strong><br>
  <i style="background:#d73027"></i> Out of Control<br>
  <i style="background:#fc8d59"></i> Being Held<br>
  <i style="background:#fee08b"></i> Under Control<br>
  <i style="background:#91bfdb"></i> Out<br>
  <i style="background:#cccccc"></i> Unknown/Other
</div>

<!-- Info box for hover details -->
<div id="infoBox"></div>

<script>
  const pointAPI = 'https://delivery.maps.gov.bc.ca/arcgis/rest/services/whse/bcgw_pub_whse_land_and_natural_resource/MapServer/20';

  // BC Albers projection (EPSG:102190)
  proj4.defs("EPSG:102190", "+proj=aea +lat_1=50 +lat_2=58.5 +lat_0=45 +lon_0=-126 " +
    "+x_0=1000000 +y_0=0 +datum=NAD83 +units=m +no_defs");

  let map, layerGroup, userMarker;
  let refreshTimer, userLat, userLon;

  // Map fire statuses to colors
  const statusColors = {
    "OUT": "#91bfdb",              // Out
    "UNDER CONTROL": "#fee08b",   // Under Control
    "BEING HELD": "#fc8d59",      // Being Held
    "OUT OF CONTROL": "#d73027",  // Out of Control
  };

  const infoBox = document.getElementById('infoBox');

  initMap();

  function initMap(lat = 53.9171, lon = -122.7497) {
    map = L.map('map').setView([lat, lon], 7);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);
    layerGroup = L.layerGroup().addTo(map);
  }

  function getLocation() {
    navigator.geolocation?.getCurrentPosition(
      pos => checkLoc(pos.coords.latitude, pos.coords.longitude),
      showError
    );
  }

  function manualCheck() {
    const lat = parseFloat(document.getElementById('lat').value);
    const lon = parseFloat(document.getElementById('lon').value);
    if (!isNaN(lat) && !isNaN(lon)) {
      checkLoc(lat, lon);
    } else {
      alert("Please enter valid coordinates.");
    }
  }

  function updateRadiusLabel() {
    const radius = document.getElementById("radiusSlider").value;
    document.getElementById("radiusLabel").textContent = radius;
  }

  function getRadiusMeters() {
    return parseInt(document.getElementById("radiusSlider").value, 10) * 1000;
  }

  function checkLoc(lat, lon) {
    userLat = lat;
    userLon = lon;
    map.setView([lat, lon], 7);
    layerGroup.clearLayers();
    if (userMarker) map.removeLayer(userMarker);
    userMarker = L.marker([lat, lon]).addTo(layerGroup).bindPopup("üìç You").openPopup();
    document.getElementById("status").innerText = "Querying nearby fires‚Ä¶";
    queryFires();
    if (document.getElementById("autoRefresh").checked) {
      clearInterval(refreshTimer);
      refreshTimer = setInterval(() => queryFires(), 60000);
    } else {
      clearInterval(refreshTimer);
    }
  }

  function showFireInfo(props) {
    infoBox.innerHTML = `
      <strong>üî• Fire Info</strong><br>
      <b>ID:</b> ${props.FIRE_NUMBER || 'N/A'}<br>
      <b>Status:</b> ${props.FIRE_STATUS || 'Unknown'}<br>
      <b>Size:</b> ${props.SIZ_HA || 'N/A'} ha
    `;
    infoBox.style.display = 'block';
  }

  function hideFireInfo() {
    infoBox.style.display = 'none';
    infoBox.innerHTML = '';
  }

  function queryFires() {
    const radiusMeters = getRadiusMeters();
    const radiusKm = radiusMeters / 1000;

    // Convert WGS84 user location to BC Albers (EPSG:102190)
    const [searchX, searchY] = proj4("EPSG:4326", "EPSG:102190", [userLon, userLat]);

    const params = new URLSearchParams({
      where: "1=1",
      geometry: `${searchX},${searchY}`,
      geometryType: "esriGeometryPoint",
      spatialRel: "esriSpatialRelIntersects",
      distance: radiusMeters,
      inSR: "102190",
      outFields: "*",
      outSR: "4326", // output geometries in lat/lon
      f: "json"
    });

    fetch(pointAPI + "/query?" + params)
      .then(res => res.json())
      .then(resp => {
        if (resp.error) {
          document.getElementById("status").innerText = "API error: " + resp.error.message;
          return;
        }

        const fires = resp.features || [];
        if (fires.length === 0) {
          document.getElementById("status").innerText = `‚úÖ No nearby fires within ${radiusKm} km.`;
          hideFireInfo();
          return;
        }

        document.getElementById("status").innerText = `‚ö†Ô∏è ${fires.length} fire(s) detected within ${radiusKm} km`;

        layerGroup.clearLayers();

        const bounds = [];

        fires.forEach(f => {
          const g = f.geometry;
          const props = f.attributes || {};
          const statusRaw = (props.FIRE_STATUS || "").toUpperCase().trim();
          const statusColor = statusColors[statusRaw] || "#cccccc";

          if (g.rings && Array.isArray(g.rings)) {
            const latlngs = g.rings.map(ring =>
              ring.map(coord => [coord[1], coord[0]])
            );

            const poly = L.polygon(latlngs, {
              color: statusColor,
              fillColor: statusColor,
              weight: 2,
              fillOpacity: 0.5
            }).addTo(layerGroup);

            poly.bindPopup(`
              üî• Fire ID: ${props.FIRE_NUMBER || 'N/A'}<br>
              Status: ${props.FIRE_STATUS || 'Unknown'}<br>
              Size: ${props.SIZ_HA || 'N/A'} ha
            `);

            // Show info on hover
            poly.on('mouseover', () => showFireInfo(props));
            poly.on('mouseout', () => hideFireInfo());

            bounds.push(...latlngs.flat());
          } else if (g.x != null && g.y != null) {
            const lat = g.y;
            const lon = g.x;

            const circle = L.circleMarker([lat, lon], {
              radius: 10,
              fillColor: statusColor,
              color: "#444",
              weight: 1,
              opacity: 1,
              fillOpacity: 0.8
            }).addTo(layerGroup);

            circle.bindPopup(`
              üî• Fire ID: ${props.FIRE_NUMBER || 'N/A'}<br>
              Status: ${props.FIRE_STATUS || 'Unknown'}<br>
              Size: ${props.SIZ_HA || 'N/A'} ha
            `);

            // Show info on hover
            circle.on('mouseover', () => showFireInfo(props));
            circle.on('mouseout', () => hideFireInfo());

            bounds.push([lat, lon]);
          } else {
            console.warn("Skipping fire with invalid geometry:", g);
          }
        });

        if (bounds.length > 0) {
          map.fitBounds(bounds, { padding: [20, 20] });
        }
      })
      .catch(err => {
        console.error("API fetch error:", err);
        document.getElementById("status").innerText = "‚ùå Failed to load fire data.";
        hideFireInfo();
      });
  }

  function showError(e) {
    const msg = {
      1: "Permission denied",
      2: "Position unavailable",
      3: "Timeout"
    }[e.code] || "Unknown error";
    document.getElementById("status").innerText = `Geolocation error: ${msg}`;
  }

  updateRadiusLabel(); // Initialize radius label
</script>

</body>
</html>
