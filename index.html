<!DOCTYPE html>
<html>
<head>
  <title>BC Wildfire Map (With Circle Markers)</title>
  <meta charset="utf‚Äë8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    #map { height: 500px; margin-top: 15px; }
    body { font-family: Arial, sans-serif; padding: 10px; }
    .controls { margin-bottom: 10px; }
    label, input, select { display: block; margin: 4px 0; }
  </style>
</head>
<body>

<h2>üî• BC Wildfire Map (Circle Markers)</h2>

<div class="controls">
  <button onclick="getLocation()">üìç Use My Location</button><br>
  <label>Or manually:</label>
  Lat: <input type="number" id="lat" step="any" placeholder="49.xxx">
  Lon: <input type="number" id="lon" step="any" placeholder="-123.xxx">
  <button onclick="manualCheck()">Check Coordinates</button>

  <label>Status Filter:</label>
  <select id="statusFilter">
    <option value="">All</option>
    <option value="OUT">OUT</option>
    <option value="ACTIVE">ACTIVE</option>
    <option value="BEING HELD">BEING HELD</option>
  </select>

  <label><input type="checkbox" id="autoRefresh"> Auto‚Äërefresh every 60‚ÄØs</label>
</div>

<p id="status">Status: Waiting‚Ä¶</p>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
  const pointAPI = 'https://delivery.maps.gov.bc.ca/arcgis/rest/services/whse/bcgw_pub_whse_land_and_natural_resource/MapServer/20';
  const finalUrl = proxyUrl + pointAPI;

  let hasStatusField = false;
  let map, layerGroup, userMarker;
  let refreshTimer, userLat, userLon;

  initMap();
  checkLayerMetadata();

  function initMap(lat = 53.7, lon = -127.6) {
    map = L.map('map').setView([lat, lon], 6);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OSM' }).addTo(map);
    layerGroup = L.layerGroup().addTo(map);
  }

  function checkLayerMetadata() {
    fetch(finalUrl + "?f=json")
      .then(res => res.json())
      .then(meta => {
        console.log("Layer metadata:", meta);
        if (meta.fields && meta.fields.some(f => f.name === "FIRE_STATUS")) {
          hasStatusField = true;
          console.log("FIRE_STATUS is available.");
        } else {
          console.warn("FIRE_STATUS is not present in this layer.");
        }
      })
      .catch(err => console.error("Metadata fetch failed:", err));
  }

  function getLocation() {
    navigator.geolocation?.getCurrentPosition(p => checkLoc(p.coords.latitude, p.coords.longitude), showError);
  }

  function manualCheck() {
    const lat = parseFloat(document.getElementById('lat').value);
    const lon = parseFloat(document.getElementById('lon').value);
    if (!isNaN(lat) && !isNaN(lon)) checkLoc(lat, lon);
    else alert("Enter valid coordinates.");
  }

  function checkLoc(lat, lon) {
    userLat = lat; userLon = lon;
    map.setView([lat, lon], 10);
    layerGroup.clearLayers();
    if (userMarker) map.removeLayer(userMarker);
    userMarker = L.marker([lat, lon]).addTo(layerGroup).bindPopup("üìç You").openPopup();
    document.getElementById("status").innerText = "Querying fires‚Ä¶";
    queryFires();
    if (document.getElementById("autoRefresh").checked) {
      clearInterval(refreshTimer);
      refreshTimer = setInterval(() => queryFires(), 60000);
    } else clearInterval(refreshTimer);
  }

  function queryFires() {
    const statusVal = document.getElementById("statusFilter").value;
    const where = hasStatusField && statusVal ? `FIRE_STATUS='${statusVal}'` : "1=1";
    const params = new URLSearchParams({
      where,
      geometry: `${userLon},${userLat}`,
      geometryType: "esriGeometryPoint",
      spatialRel: "esriSpatialRelIntersects",
      distance: 10000,
      inSR: "4326",
      outFields: "*",
      f: "json"
    });

    fetch(finalUrl + "/query?" + params)
      .then(res => res.json())
      .then(resp => {
        console.log("Query response:", resp);
        if (resp.error) {
          document.getElementById("status").innerText = "API error: " + resp.error.message;
          return;
        }
        const feats = resp.features || [];
        if (!feats.length) {
          document.getElementById("status").innerText = "‚úÖ No fires found.";
          return;
        }
        document.getElementById("status").innerText = `‚ö†Ô∏è ${feats.length} fire(s) matched.`;
        feats.forEach(f => {
          if (!f.geometry?.x) return;
          const lat = f.geometry.y, lon = f.geometry.x;
          const props = f.attributes || {};
          
          // Set fire status to color mapping
          const fireStatus = props.FIRE_STATUS || 'Unknown';
          const color = getStatusColor(fireStatus);

          // Create a circle marker for the fire location
          L.circleMarker([lat, lon], {
            radius: 8,
            fillColor: color,
            color:
